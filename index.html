<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time-Table</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            margin: 0px;
            text-align: center;
        }

        table {
            margin: auto;
            font-size: 15px;
        }

        .nav {
            background-color: black;
            color: rgb(255, 255, 255);
            padding: 10px;
            margin: 0px;
            position: sticky;
            top:0px;
            font-size: 30px;
        }


        table>thead>tr>th {
            padding: 20px;
            border: 2px solid red;
            /* width:90%; */


        }
        

        td {
            border: 2px solid blue;
            padding: 15px;
        }

        select {
            font-size: 20px;
            margin: 20px;
        }

        #add {
            font-size: 20px;
        }

        .add {
            position: sticky;
            background-color: rgba(0, 0, 0, 0.604);
            color: #fafafa;
            width: 100%;
            height: 10%;
            top: 30px;
        }
th{
    position: sticky;
    top:85px;
    background-color: rgba(255, 255, 255, 0.852);
}
        select {
            padding: 5px;
            margin: 5px;
            margin-top: 15px;
            border-radius: 10px;
        }

        .Actions{
           position: absolute;
           right: 0px;
        }
    </style>
</head>

<body>
    <div class="nav">Timetable <div class="Actions" style="display:inline;">
        <button class="reset" onclick="reset()">RESET</button>
        <input type="file" id="importJson" accept=".json">
        <button onclick="downloadJSON(DATA, 'data.json')">Export as JSON</button>
    </div></div>
    <div class="add">
        <select name="" id="DAY">

        </select>
        <select name="" id="SUB">


        </select>
        <select name="" id="PER">

        </select>
        <select name="" id="INS">

        </select>
        <select name="" id="CRED">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
        <button id="add" onclick="addRow()">ADD/CHANGE</button>


    </div>
    <div class="Container">
        <table>
            <thead>
                <tr>
                    <th>PERIOD</th>
                </tr>
            </thead>
            <tbody id="ContentArea">

            </tbody>
        </table>
        
    </div>
    <script>
        let day = new Date();
        // console.log(day.getDay());
        let databoxes;
        let x;
        let CRED = document.querySelector('#CRED');
        let Box = document.querySelector('#ContentArea');
        let header = document.querySelector('tr');
        let Days = ["MONDAY", "TUESDAY", "WEDENESDAY", "THURSDAY", "FRIDAY"]
        let Lectures = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        let subjects = ["Electronic Devices", "Digital Electronics", "Signals & Systems", "Data Structures & Algorithms", "* IoT Design ", "Electrical Circuit & Analysis", "Cyber Law & Ethics", "Design Thinking and Innovation-I", "QAPD-I", "Summer Internship-I", "Constitution of India", "BREAK", "DSA LAB", "ELectronics Devices Lab", "MRIIRS 3ECE+EE APTI", "MRIIRS 3ECE+EE Soft Skills", "IOT Design Lab", "    "];
        let instructor = [
            "Dr. Vimlesh Singh",                // Electronic Devices
            "Dr. Pratima",                      // Digital Electronics
            "Dr. Manish Mishra",                // Signals & Systems
            "Ms. Vibha ,Ms. Snigdha",       // QAPD-I
            "Dr. Vandana, CSE(Spe.)",           // Data Structures & Algorithms and Cyber Law & Ethics
            "Dr. Ashu Gautam",                  // Design Thinking and Innovation-I
            "Dr. Amana Yadav",                  // Summer Internship-I
            "Dr. Umesh Dutta",                  // IoT Design
            "NF",                               // Constitution of India
            "Dr. Leena G.",
            "O.A",
            "  "
            // Electrical Circuit & Analysis
        ];

        const timeSlots = [
            "8:10 – 9:00",
            "9:00–9:50",
            "9:50–10:40",
            "10:40–11:30",
            "11:30–12:20",
            "12:20–1:10",
            "1:10–2:00",
            "2:00–2:50",
            "2:50–3:40",
            "3:40–4:30"
        ];



        let SUB = document.querySelector("#SUB");
        let PER = document.querySelector("#PER");
        let DATA = new Object;
        let INS = document.querySelector("#INS");
        let DAY = document.querySelector('#DAY');

        class LECDATA {
            constructor(s, n, ins, c, id) {
                this.Sub = s;
                this.Period = n;
                this.ins = ins;
                this.credit = c;
                this.id = id;

            }

        }





        let populate = () => {
            subjects.forEach((i, j) => {
                SUB.innerHTML += `<option value="${j}">${i}</option>`

            })

            Lectures.forEach(i => {
                PER.innerHTML += `<option value="${i}">${i}(${timeSlots[i - 1]})</option>`
            })

            instructor.forEach((i, j) => {
                INS.innerHTML += `<option value="${j}">${i}</option>`
            });

            Days.forEach((i, j) => {
                DAY.innerHTML += `<option value="${j}">${i}</option>`
                Box.innerHTML += `<tr class="${i}" ><td>${Days[j]}</td></tr>`
                if (j === (day.getDay() - 1)) {
                    document.querySelector(`.${i}`).style.backgroundColor = " rgba(131, 253, 0, 0.7)";
                };

                if (j === (day.getDay())) {
                    document.querySelector(`.${i}`).style.backgroundColor = " yellow";
                }
            })


            DAY.addEventListener('click', () => { PER.value = 1 });
            //              databoxes = document.querySelectorAll('td');
            //  x  = Array.from(databoxes);
            //  console.log(x)



        }
        populate()

        let addRow = () => {
            let CurDay = Days[DAY.value];
            if (!DATA[CurDay]) {
                DATA[CurDay] = new Array(Lectures.length)
            }
            let genID = Math.floor(Math.random() * 10000000);
            DATA[CurDay][PER.value - 1] = new LECDATA(subjects[SUB.value], Lectures[PER.value - 1], instructor[INS.value], CRED.value, genID);

            // Box.innerHTML = "";

            //    let tr = document.querySelector(`.${Days[DAY.value]}`)
            //    console.log(tr);

            //     tr.innerHTML += `
            //         <td>${DATA[(PER.value -1)].Sub}  ${DATA[(PER.value -1)].ins}</td>
            //         `
            let perNum = Number(PER.value);
            if (!isNaN(perNum) && perNum < 10) {
                PER.value = String(perNum + 1);
            }
            localStorage.setItem('LECTURE', JSON.stringify(DATA));
            location.reload();


        }
        let reset = () => {
            Days.forEach((i, j) => {
                DATA[i] = new Array(Lectures.length); // Initialize array for each day
                Lectures.forEach((u, k) => {
                    let GENID = (Math.floor(Math.random() * 10000000))
                    DATA[i][k] = new LECDATA("NA", k, "NA", 1, GENID)

                })
            }

            )
            localStorage.setItem('LECTURE', JSON.stringify(DATA));
            location.reload()

        }

        let render = () => {
            if (localStorage.getItem('LECTURE')) {
                DATA = JSON.parse(localStorage.getItem('LECTURE'))
            } else {

                reset()

            }

            Lectures.forEach(i => {
                header.innerHTML += `<th>${i}<br>${timeSlots[i - 1]}</th>`

            })





            Days.forEach(i => {
                if (DATA[i]) {
                    let limit = 0;
                    let tr = document.querySelector(`.${i}`);
                    // tr.innerHTML = ""; // Clear previous contents

                    DATA[i].forEach(j => {
                        if (j != null && j != undefined) {
                            if (limit + Number(j.credit) <= 10) {
                                tr.innerHTML += `<td id="${j.id}" colspan="${j.credit}">${j.Sub}<hr>${j.ins}</td>`;
                                limit += Number(j.credit);
                                // console.log(typeof(j.credit),"this one")
                            } else {
                                console.warn(`Limit reached for ${i} row`);
                            }
                        }
                    });
                } else {
                    console.error("value not found for", i);
                }
            });


        }
        render();

        let listener = document.querySelectorAll('td');
        listener.forEach(i => {



            i.addEventListener('click', (e) => {
                let parent = e.target.parentElement.className; // Gets the day like 'MONDAY'
                // console.log(e.target)
                listener.forEach(cell => {
            cell.style.backgroundColor = "";
            cell.style.border = "";
        });
                e.target.style.backgroundColor = "#0686e288";
                e.target.style.border = "2px solid black"


                if (Array.isArray(DATA[parent])) {
                    let Associate = DATA[parent].find(obj => obj && obj.id == e.target.id);

                    if (Associate) {
                        console.log(Associate); // For debug

                        // Set DAY dropdown
                        // ✅ 1. Set DAY <select> (by visible text)
                        let dayIndex = Array.from(DAY.options).findIndex(opt => opt.text.trim() === parent.trim());
                        if (dayIndex !== -1) DAY.selectedIndex = dayIndex;

                        // Set SUBJECT dropdown by matching text
                        let subIndex = Array.from(SUB.options).findIndex(opt => opt.text.trim() === Associate.Sub.trim());
                        if (subIndex !== -1) SUB.selectedIndex = subIndex;

                        // Set INSTRUCTOR dropdown by matching text
                        let insIndex = Array.from(INS.options).findIndex(opt => opt.text.trim() === Associate.ins.trim());
                        if (insIndex !== -1) INS.selectedIndex = insIndex;

                        // Set CREDIT dropdown by matching value
                        let credIndex = Array.from(CRED.options).findIndex(opt => opt.value == Associate.credit);
                        if (credIndex !== -1) CRED.selectedIndex = credIndex;

                        PER.value = Associate.Period + 1;
                    }
                }
            });
        });





        let Advlistener = document.querySelectorAll('td');
        listener.forEach(i => {
            i.addEventListener('click', (e) => {
                let parent = e.target.parentElement.className; // Gets the day like 'MONDAY'

                if (Array.isArray(DATA[parent])) {
                    let Associate = DATA[parent].find(obj => obj && obj.id == e.target.id);

                    if (Associate) {
                        console.log(Associate); // For debug

                        // Set DAY dropdown
                        // ✅ 1. Set DAY <select> (by visible text)
                        let dayIndex = Array.from(DAY.options).findIndex(opt => opt.text.trim() === parent.trim());
                        if (dayIndex !== -1) DAY.selectedIndex = dayIndex;

                        // Set SUBJECT dropdown by matching text
                        let subIndex = Array.from(SUB.options).findIndex(opt => opt.text.trim() === Associate.Sub.trim());
                        if (subIndex !== -1) SUB.selectedIndex = subIndex;

                        // Set INSTRUCTOR dropdown by matching text
                        let insIndex = Array.from(INS.options).findIndex(opt => opt.text.trim() === Associate.ins.trim());
                        if (insIndex !== -1) INS.selectedIndex = insIndex;

                        // Set CREDIT dropdown by matching value
                        let credIndex = Array.from(CRED.options).findIndex(opt => opt.value == Associate.credit);
                        if (credIndex !== -1) CRED.selectedIndex = credIndex;

                        PER.value = Associate.Period + 1;
                    }
                }
            });
        });

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            saveAs(blob, filename);
        }


        document.getElementById("importJson").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    console.log("Imported Data:", importedData);

                    // Now set it to DATA or localStorage
                    localStorage.setItem("LECTURE", JSON.stringify(importedData));
                    DATA = importedData;

                    // Optionally re-render your UI
                    // render();
                    location.reload()

                } catch (err) {
                    alert("Invalid JSON file");
                    console.error("Error parsing JSON:", err);
                }
            };

            reader.readAsText(file);
        });






    </script>

</body>

</html>